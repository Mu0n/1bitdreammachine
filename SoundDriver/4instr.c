#include "Sound.h"#include "Misc.c"#include "math.h"#define PI 3.141593#define kBase 1024#define kInFront (WindowPtr)-1L/* Control item list */#define kRedraw  1#define kSineWave 2#define kSquareWave 3#define kTriangularWave 4#define k1stChan 5#define k2ndChan 6#define k3rdChan 7#define k4thChan 8#define kSaveWave 9#define kLoadWave 10#define kQuit 11#define kPlaySound 13#define kStopSound 14#define k1stChanOn  16#define k2ndChanOn  17#define k3rdChanOn  18#define k4thChanOn  19#define kEditRect   20#define kOn 1#define kOff 0DialogPtr myDialog;Wave gInst[4];short gChannel = 0;short gPlay1st = true;short gPlay2nd = false;short gPlay3rd = false;short gPlay4th = false;short gQuit = false;void SetUpSpace(void);void Music(void);void PutSine(int which);void PutTriangle(int which);void PutSquare(int which);void DrawWaveTable(int which);void CorrectWaveTable(Point where, int which);void HandleSave(int which);void HandleLoad(int which);void main(void)  {  InitMacStuff();  WholeScreen(white,true);  SetUpSpace();  Music();  }void SetUpSpace(void)  {  short iType;  Rect iRect;  Handle iHandle;    myDialog = GetNewDialog(kBaseResID,nil,kInFront);  GetDItem(myDialog,k1stChan,&iType,&iHandle,&iRect);  SetCtlValue((ControlHandle)iHandle,kOn);    GetDItem(myDialog,k1stChanOn,&iType,&iHandle,&iRect);  SetCtlValue((ControlHandle)iHandle,kOn);  SetPort(myDialog);  ShowWindow(myDialog);  DrawControls(myDialog);    GetDItem(myDialog,kQuit,&iType,&iHandle,&iRect);  PlotIcon(&iRect,iHandle);  }  void PutSine(int which)  {  int i;    for(i=0;i<256;i++)    {    gInst[which][i] = 127*sin(2*i*PI/256)+127;    }  }void PutTriangle(int which)  {  int i;      for(i=0;i<64;i++)    {    gInst[which][i] = 127+2*i;      }         for(i=64;i<192;i++)    {    gInst[which][i] = 255-2*(i-64);      }         for(i=192;i<256;i++)    {    gInst[which][i] = 0+2*(i-192);      }  }void PutSquare(int which)  {  int i;      for(i=0;i<256;i++)    {    gInst[which][i] = (i>127 ? 0:255);      }  }void Music(void)  {  short itemHit, iType;  Rect r, iRect;  Handle iHandle;  int i,rate1,rate2,rate3,rate4;  FTSoundRec mySnd;  FTSynthRec myRec;  Point mPt;    EventRecord wutup;    SetRect(&r,1,300-255,257,302);      PutSine(0);    PutTriangle(1);    PutSquare(2);    PutSquare(3);          DrawWaveTable(0);    mySnd.duration = 1000;  mySnd.sound1Rate = FixRatio(1,1);        mySnd.sound2Rate = FixRatio(3,2);        mySnd.sound3Rate = FixRatio(2,1);        mySnd.sound4Rate = FixRatio(10,7);  mySnd.sound1Phase = 0;  mySnd.sound2Phase = 0;  mySnd.sound3Phase = 0;  mySnd.sound4Phase = 0;  mySnd.sound1Wave = &gInst[0];      mySnd.sound2Wave = &gInst[1];      mySnd.sound3Wave = &gInst[2];      mySnd.sound4Wave = &gInst[3];    myRec.mode = ftMode;  myRec.sndRec = &mySnd;    StartSound(&myRec,256,nil);  rate1=kBase;  rate2=kBase;  rate3=kBase;  rate4=kBase;        while(!gQuit)    {    mySnd.duration = 1000;        if(gPlay1st) mySnd.sound1Rate = FixRatio(1,1);     else   mySnd.sound1Rate = 0;    if(gPlay2nd) mySnd.sound2Rate = FixRatio(3,2);     else mySnd.sound2Rate = 0;    if(gPlay3rd) mySnd.sound3Rate = FixRatio(2,1);       else mySnd.sound3Rate = 0;    if(gPlay4th) mySnd.sound4Rate = FixRatio(10,7);       else mySnd.sound4Rate = 0;        ModalDialog(nil,&itemHit);    switch(itemHit)      {      case kRedraw:        DrawWaveTable(gChannel);        break;      case kStopSound:      	if(!SoundDone()) StopSound();      	break;      case kPlaySound:        if(SoundDone()) StartSound(&myRec,256,nil);        else {          StopSound();          StartSound(&myRec,256,nil);          }        break;      case k1stChan:        gChannel = 0;        GetDItem(myDialog,k1stChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOn);        GetDItem(myDialog,k2ndChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k3rdChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k4thChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        DrawWaveTable(gChannel);        break;      case k2ndChan:        gChannel = 1;        GetDItem(myDialog,k1stChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k2ndChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOn);        GetDItem(myDialog,k3rdChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k4thChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        DrawWaveTable(gChannel);        break;      case k3rdChan:        gChannel = 2;        GetDItem(myDialog,k1stChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k2ndChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k3rdChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOn);        GetDItem(myDialog,k4thChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        DrawWaveTable(gChannel);        break;      case k4thChan:        gChannel = 3;        GetDItem(myDialog,k1stChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k2ndChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k3rdChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOff);        GetDItem(myDialog,k4thChan,&iType,&iHandle,&iRect);        SetCtlValue((ControlHandle)iHandle,kOn);        DrawWaveTable(gChannel);        break;      case kQuit:        gQuit = true;      	break;      case kSineWave:        PutSine(gChannel);        DrawWaveTable(gChannel);        break;      case kSquareWave:        PutSquare(gChannel);        DrawWaveTable(gChannel);        break;      case kTriangularWave:        PutTriangle(gChannel);        DrawWaveTable(gChannel);        break;      case k1stChanOn:        GetDItem(myDialog,k1stChanOn,&iType,&iHandle,&iRect);        if(GetCtlValue((ControlHandle)iHandle) == kOff)          {          SetCtlValue((ControlHandle)iHandle,kOn);          gPlay1st = true;          }        else { SetCtlValue((ControlHandle)iHandle,kOff);          gPlay1st = false;          }        break;      case k2ndChanOn:        GetDItem(myDialog,k2ndChanOn,&iType,&iHandle,&iRect);        if(GetCtlValue((ControlHandle)iHandle) == kOff)          {          SetCtlValue((ControlHandle)iHandle,kOn);          gPlay2nd = true;          }        else { SetCtlValue((ControlHandle)iHandle,kOff);          gPlay2nd = false;          }        break;      case k3rdChanOn:        GetDItem(myDialog,k3rdChanOn,&iType,&iHandle,&iRect);        if(GetCtlValue((ControlHandle)iHandle) == kOff)          {          SetCtlValue((ControlHandle)iHandle,kOn);          gPlay3rd = true;          }        else { SetCtlValue((ControlHandle)iHandle,kOff);          gPlay3rd = false;          }        break;      case k4thChanOn:        GetDItem(myDialog,k4thChanOn,&iType,&iHandle,&iRect);        if(GetCtlValue((ControlHandle)iHandle) == kOff)          {          SetCtlValue((ControlHandle)iHandle,kOn);          gPlay4th = true;          }        else { SetCtlValue((ControlHandle)iHandle,kOff);          gPlay4th = false;          }        break;      case kEditRect:                while(Button())          {          GetMouse(&mPt);          if(PtInRect(mPt,&r))            {            CorrectWaveTable(mPt,gChannel);            }          }        break;      case kSaveWave:        HandleSave(gChannel);        break;      case kLoadWave:        HandleLoad(gChannel);        break;      }    }  StopSound();  }  void DrawWaveTable(int which)  {  int i;  Rect r;    SetRect(&r,0,300-255,258,303);  FillRect(&r,white);  FrameRect(&r);  for(i=0;i<256;i++)    {    MoveTo(i+1,300-gInst[which][i]+1);    LineTo(i+1,300-gInst[which][i]+1);      }  }  void CorrectWaveTable(Point where, int which)  {  MoveTo(where.h,46);  PenMode(patBic);  LineTo(where.h,301);  MoveTo(where.h,where.v);  PenMode(patCopy);  LineTo(where.h,where.v);    gInst[which][where.h-1]=300-where.v+1;  }  void HandleSave(int which)  {  SFReply reply;  OSErr err;  short fRefNum;  Point dialogPos={30,30};  long count;    SFPutFile(dialogPos,"\p","\pUntitled",nil,&reply);  if(reply.good)    {    Create(reply.fName,reply.vRefNum,'????','4TON');    FSOpen(reply.fName,reply.vRefNum,&fRefNum);    count=256;    FSWrite(fRefNum,&count,&gInst[which]);    FSClose(fRefNum);    }  DrawWaveTable(gChannel);  }void HandleLoad(int which)  {  SFReply reply;  OSErr err;  short fRefNum;  Point dialogPos={30,30};  long count;  SFTypeList myTypes;    myTypes[0]='4TON';    fRefNum = OldLoadFile(myTypes);  if(fRefNum)    {    count=256;    FSRead(fRefNum,&count,&gInst[which]);    FSClose(fRefNum);    }  DrawWaveTable(gChannel);  }